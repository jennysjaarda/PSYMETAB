---
title: "Project setup"
author: "Jenny Sjaarda"
output: workflowr::wflow_html
---

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE)
```

**Last updated:** `r Sys.Date()`

**Code version:** `r system("git log -1 --format='%H'", intern = TRUE)`

**To reproduce these results, please follow these instructions.**
**See [Data] for details on data sources.**

## Step 1: initiate project on remote server.

All processing scripts were run from the root sgg directory.
Project was initialized using `workflowr` rpackage, see [here](https://jdblischak.github.io/workflowr/articles/wflow-01-getting-started.html).

On sgg server:

```{r eval=FALSE}
project_name <- "PSYMETAB"
library("workflowr")

wflow_start(project_name) # creates directory called project_name

options("workflowr.view" = FALSE) # if using cluster
wflow_build() # create directories
options(workflowr.sysgit = "")

wflow_publish(c("analysis/index.Rmd", "analysis/about.Rmd", "analysis/license.Rmd"),
              "Publish the initial files for myproject")

wflow_use_github("jennysjaarda") # select option 2: manually create new repository

wflow_git_push()
```

You have now successfully created a github repository for your project that is accessible on github and the servers.

Next setup a local copy.

## Step 2: Create local copy on personal computer.

Within terminal of personal computer, clone the git repository.

 ```bash
cd ~/Dropbox/UNIL/projects/
git clone https://github.com/jennysjaarda/PSYMETAB.git PSYMETAB
 ```

Open project in atom (or preferred text editor) and modify the following files:

- Because Terminal cannot generate a preview and `workflowr` doesn't like the sysgit, to the `.Rprofile` file, add:
  - `options(workflowr.sysgit = "")`
  - `options("workflowr.view" = FALSE)`
- To ensure git hub isn't manaaging large files, modify the `.gitignore` file, by adding the following lines:
  - `data/*`
  - `!analysis/*.Rmd`
  - `!data/*.md`
  - `.git/`
- Save and push these changes to github.
- Pull to the server.

## Step 3: Create internal project folders.

Return to sgg server and run the following:

```bash
project_dir=/data/sgg2/jenny/projects/PSYMETAB
mkdir $project_dir/data/raw
mkdir $project_dir/data/processed
mkdir $project_dir/data/raw/reference_files
mkdir $project_dir/data/raw/phenotype_data
mkdir $project_dir/data/raw/extraction
mkdir $project_dir/data/processed/phenotype_data
mkdir $project_dir/data/processed/extraction
mkdir $project_dir/docs/assets
```

This will create the following directory structure in `PSYMETAB/`:

```
PSYMETAB/
├── .gitignore
├── .Rprofile
├── _workflowr.yml
├── analysis/
│   ├── about.Rmd
│   ├── index.Rmd
│   ├── license.Rmd
│   └── _site.yml
├── code/
│   ├── README.md
├── data/
│   ├── README.md
│   ├── raw/
|       ├── phenotype_data/
|       ├── reference_files/
|       └── extraction/
│   └── processed/
|       ├── phenotype_data/
|       ├── reference_files/
|       └── extraction/
├── docs/
|       └── assets/
├── myproject.Rproj
├── output/
│   └── README.md
└── README.md
```

Raw PLINK (ped/map files) data were copied from the CHUV `:L/` folder after being built in genomestudio.

## Step 4: Setup drake plan.

see `make.R`

Configure a slurm template
```{r eval=FALSE}
options(clustermq.scheduler = "slurm", clustermq.template = "slurm_clustermq.tmpl")
drake_hpc_template_file("slurm_clustermq.tmpl")

# Write the file slurm_clustermq.tmpl. and edit manually
```

The file created using the `clustermq` template was edited manually to match [slurm_clustermq.tmpl](https://github.com/jennysjaarda/PSYMETAB/blob/master/slurm_clustermq.tmpl)

```{r comment=''}
cat(readLines('slurm_clustermq.tmpl'), sep = '\n')
```
